<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-selector/iron-selector.html">


<!--
A data component with map, reduce, reduceRight and filter functions.

##### Example

    <lens-data-array-func></lens-data-array-func>

@element lens-data-array-func
@blurb A data component with map, reduce and filter functions.
@status alpha
@homepage http://lenses.github.io/lens-data-array-func
-->
<dom-module id="lens-data-array-func">
  <link rel="import" type="css" href="lens-data-array-func.css">
  <template>

    <div class="lens-container lens-data">

          <label>function: </label>
          <iron-selector id="selectedFunc" selected="{{functionName}}" attr-for-selected="label">
            <template is="dom-repeat" items="{{_functions}}" as="func">
              <div label="{{func.name}}" class="item">{{func.name}}</div>
            </template>

          </iron-selector>


          <div class="error">{{displayError}}</div>
          <span class="func-signature code">
          <span>{{_signature}}</span>
          </span>
      <!--     <textarea id="map_function" value="{{functionContent}}"></textarea>
       -->
          <textarea value="{{functionContent::input}}" class="code" placeholder="enter map function" rows="4">&gt;</textarea>
          <span class="func-temppate"> } </span>

    </div>

  </template>
</dom-module>
<script>
  Polymer({
    is: 'lens-data-array-func',
    properties: {
      _funcNames: {
        type: Array,
        value: function () {
          return [
            'map',
            'reduce',
            'reduceRight',
            'filter'
          ];
        }
      },
      _functionIndex: {
        type: Number,
        value: 0
      },
      _functions: {
        type: Array,
        value: function () {
          return [
            {
              name: 'map',
              signature: 'function(current, index, array ) {',
              func: [].map,
              params: [
                'current',
                'index',
                'array'
              ]
            },
            {
              name: 'reduce',
              signature: 'function(previous, current, index, array ) {',
              func: [].reduce,
              params: [
                'previous',
                'current',
                'index',
                'array'
              ]
            },
            {
              name: 'reduceRight',
              signature: 'function(previous, current, index, array ) {',
              func: [].reduceRight,
              params: [
                'previous',
                'current',
                'index',
                'array'
              ]
            },
            {
              name: 'filter',
              signature: 'function(current) {',
              func: [].filter,
              params: ['current']
            }
          ];
        }
      },
      displayError: {
        type: String,
        value: ''
      },
      error: {
        type: String,
        value: '',
        observer: 'errorChanged'
      },
      //functionBody: { observer: 'functionChanged' },
      functionContent: {
        notify: true,
        observer: 'functionChanged'
      },
      functionName: {
        type: String,
        value: 'map',
        notify: true,
        observer: 'functionChanged'
      },
      input: {
        value: null,
        notify: true,
        observer: '_calculateOutput'
      },
      output: {
        value: null,
        notify: true
      }
    },
    _function: undefined,
    functionChanged: function () {
      var self = this;
      self._functionIndex = self._funcNames.indexOf(self.functionName);
      self._signature = self._functions[self._functionIndex].signature;
      try {
        self._function = new Function(self._functions[self._functionIndex].params, self.functionContent);  //newFunction; //created by eval 
      } //newFunction; //created by eval 
      catch (e) {
        self.error = e.message;
        return;
      }
      self.error = '';
      if (self.input) {
        self._calculateOutput();
      }
    },
    errorChanged: function () {
      var self = this;
      if (self.error.length == 0) {
        self.displayError = '';
        return;
      }
      clearTimeout(self._timeOut);
      self._timeOut = setTimeout(function () {
        if (self.error.length > 0) {
          self.displayError = self.error;
        }
      }, 1000);
    },
    _calculateOutput: function () {
      var self = this;
      var temp = _.clone(self.input);
      if (self._function == undefined) {
        return;
      }
      try {
        self.output = self._functions[self._functionIndex].func.call(temp, self._function);  //temp.map(self._function);
      } //temp.map(self._function);
      catch (e) {
        self.error = e.message;
        return;
      }
      self.error = '';
    },
    ready: function () {
      var self = this;
      self._signature = self._functions[self._functionIndex].signature;
    }
  });
</script><script src="../lodash/lodash.js"></script>
